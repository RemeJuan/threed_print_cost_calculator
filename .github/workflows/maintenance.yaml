name: Biweekly Flutter Maintenance (Copilot Agent)

on:
  schedule:
    - cron: "0 7 */14 * *"
  workflow_dispatch: {}

permissions:
  issues: write
  contents: read

jobs:
  create_and_assign:
    runs-on: ubuntu-latest
    steps:
      - name: Create issue assigned to Copilot (GraphQL)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.COPILOT_AGENT_PAT }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const date = new Date().toISOString().slice(0, 10);

            const title = `chore: biweekly maintenance (${date})`;
            const body = [
              "Goal:",
              "- Upgrade Dart/Flutter dependencies",
              "- Run analyze + tests",
              "- Bump patch version via `make bump_fix` (amends the maintenance commit)",
              "- Open a PR to the default branch",
              "",
              "Constraints:",
              "- Keep changes minimal (no refactors, no formatting-only changes).",
              "- If a major upgrade needs real work, note it and skip it.",
              "",
              "Runbook:",
              "1) flutter pub get",
              "2) dart analyze",
              "3) flutter test",
              "4) flutter pub upgrade",
              "5) flutter pub outdated (call out majors separately)",
              "6) dart analyze",
              "7) flutter test (fix minimally until green)",
              `8) Commit: chore: biweekly maintenance (${date})`,
              "9) make bump_fix (amend commit)",
              "10) dart analyze + flutter test",
              "",
              "PR requirements:",
              `- Title: chore: biweekly maintenance (${date})`,
              "- Include dependency summary (majors called out), confirmation make bump_fix ran, analyze/test results, and any skips + why."
            ].join("\n");

            const headers = {
              "GraphQL-Features": "issues_copilot_assignment_api_support,coding_agent_model_selection"
            };

            // Query: repo id + default branch + suggestedActors
            const query = `
              query($owner: String!, $name: String!) {
                repository(owner: $owner, name: $name) {
                  id
                  defaultBranchRef { name }
                  suggestedActors(capabilities: [CAN_BE_ASSIGNED], first: 100) {
                    nodes {
                      __typename
                      login
                      ... on Bot { id }
                      ... on User { id }
                    }
                  }
                }
              }
            `;

            const repoRes = await github.request("POST /graphql", {
              headers,
              query,
              variables: { owner, name: repo }
            });

            // NOTE: in github-script, GraphQL response is nested under data.data
            const repository = repoRes?.data?.data?.repository;

            if (!repository?.id) {
              core.setFailed("Failed to read repository id from GraphQL response.");
              core.info(JSON.stringify(repoRes, null, 2));
              return;
            }

            const repositoryId = repository.id;
            const defaultBranch = repository.defaultBranchRef?.name || "main";
            const nodes = repository.suggestedActors?.nodes || [];

            core.info(`suggestedActors: ${nodes.map(n => `${n.login}:${n.__typename}`).join(", ")}`);

            const copilotActor = nodes.find(n => n.login === "copilot-swe-agent" && n.id);
            if (!copilotActor?.id) {
              core.setFailed(`Could not find copilot-swe-agent in suggestedActors. Found: ${nodes.map(n => n.login).join(", ")}`);
              return;
            }

            core.info(`Using Copilot actor: ${copilotActor.login} (${copilotActor.id})`);

            // Mutation: create issue assigned to Copilot and start agent work
            const mutation = `
              mutation($input: CreateIssueInput!) {
                createIssue(input: $input) {
                  issue {
                    number
                    url
                    assignees(first: 20) { nodes { login } }
                  }
                }
              }
            `;

            const createdRes = await github.request("POST /graphql", {
              headers,
              query: mutation,
              variables: {
                input: {
                  repositoryId,
                  title,
                  body,
                  assigneeIds: [copilotActor.id],
                  agentAssignment: {
                    targetRepositoryId: repositoryId,
                    baseRef: defaultBranch
                  }
                }
              }
            });

            const issue = createdRes?.data?.data?.createIssue?.issue;

            if (!issue?.number) {
              core.setFailed("Issue creation failed (no issue number returned).");
              core.info(JSON.stringify(createdRes, null, 2));
              return;
            }

            const assignees = issue.assignees?.nodes?.map(a => a.login) || [];
            core.info(`Created issue #${issue.number}: ${issue.url}`);
            core.info(`Issue assignees: ${assignees.join(", ")}`);

            if (!assignees.includes("copilot-swe-agent")) {
              core.setFailed(`Issue created but Copilot is not in assignees. Actual: ${assignees.join(", ")}`);
            }
