name: Biweekly Flutter Maintenance (Copilot Issue)

on:
  schedule:
    # Every 2 weeks at 07:00 UTC. Adjust as needed.
    - cron: "0 7 */14 * *"
  workflow_dispatch: {}

permissions:
  contents: read
  issues: write

jobs:
  create_issue_and_assign:
    runs-on: ubuntu-latest
    steps:
      - name: Create maintenance issue and assign to Copilot
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.COPILOT_AGENT_PAT }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const date = new Date().toISOString().slice(0, 10);
            const title = `chore: biweekly maintenance (${date})`;

            const body = `Goal:
            - Upgrade Dart/Flutter dependencies
            - Run analyze + tests
            - Bump patch version via make bump_fix (amends commit)
            - Open a PR to the default branch

            Constraints:
            - No refactors or formatting-only changes.
            - If a major upgrade needs real work, note it and skip it.

            Runbook:
            1) flutter pub get
            2) dart analyze
            3) flutter test
            4) flutter pub upgrade
            5) flutter pub outdated (call out majors)
            6) dart analyze
            7) flutter test (fix minimally)
            8) Commit: chore: biweekly maintenance (${date})
            9) make bump_fix (amend)
            10) dart analyze + flutter test

            PR requirements:
            - Title: chore: biweekly maintenance (${date})
            - Include dependency summary (majors called out), confirmation make bump_fix ran, analyze/test results, and any skipped upgrades + why.
            `;

            const created = await github.rest.issues.create({
              owner,
              repo,
              title,
              body,
              labels: ["maintenance"]
            });

            const issue_number = created.data.number;

            // Assign Copilot + the workflow actor (optional). If you only want Copilot, remove context.actor.
            await github.rest.issues.addAssignees({
              owner,
              repo,
              issue_number,
              assignees: ["copilot", context.actor]
            });

            // Re-fetch and validate assignment
            const issue = await github.rest.issues.get({ owner, repo, issue_number });
            const assignees = (issue.data.assignees || []).map(a => ({
              login: a.login,
              type: a.type
            }));

            core.info(`Created issue #${issue_number}. Assignees: ${assignees.map(a => a.login).join(", ")}`);

            const copilotAssigned = assignees.some(a =>
              (a.type === "Bot" && a.login.toLowerCase().includes("copilot")) ||
              ["copilot", "copilot-swe-agent", "copilot-swe-agent[bot]"].includes(a.login)
            );

            if (!copilotAssigned) {
              core.setFailed(
                `Issue was created but Copilot was not assigned. Actual assignees: ${assignees.map(a => a.login).join(", ")}`
              );
            }
