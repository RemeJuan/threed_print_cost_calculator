name: Biweekly Flutter Maintenance (Copilot Issue)

on:
  schedule:
    # Every 2 weeks (pick a cadence you like). This is "every 14 days" at 07:00 UTC.
    - cron: "0 7 */14 * *"
  workflow_dispatch: {}

permissions:
  contents: read
  issues: write

jobs:
  create_issue:
    runs-on: ubuntu-latest
    steps:
      - name: Create issue + assign to Copilot coding agent
        uses: actions/github-script@v7
        with:
          # Use a user token (PAT or GitHub App user-to-server token).
          # Fine-grained PAT must have:
          # - Metadata: read
          # - Actions/Contents/Issues/Pull requests: read & write
          # (per GitHub docs).
          github-token: ${{ secrets.COPILOT_AGENT_PAT }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const date = new Date().toISOString().slice(0, 10);
            const title = `chore: biweekly maintenance (${date})`;

            const body = [
              "Goal:",
              "- Upgrade Dart/Flutter dependencies",
              "- Keep the changes minimal and mechanical",
              "- Run analyze + tests",
              "- Bump patch version via `make bump_fix` (amends the maintenance commit)",
              "- Open a PR to the default branch",
              "",
              "Constraints:",
              "- No refactors or formatting-only changes.",
              "- If a major upgrade requires real work, note it and skip it rather than rewriting lots of code.",
              "- Prefer smallest possible fixes.",
              "",
              "Runbook (hosted runner):",
              "1) Baseline:",
              "- `flutter pub get`",
              "- `dart analyze`",
              "- `flutter test`",
              "",
              "2) Upgrade:",
              "- `flutter pub upgrade`",
              "- `flutter pub outdated` (call out majors separately in PR notes)",
              "",
              "3) Verify + fix:",
              "- `dart analyze`",
              "- `flutter test`",
              "",
              "4) Commit:",
              "- Single commit message: `chore: biweekly maintenance (" + date + ")`",
              "",
              "5) Version bump:",
              "- `make bump_fix` (amends the commit)",
              "- Confirm `pubspec.yaml` + `CHANGELOG.md` updated",
              "",
              "6) Final verification:",
              "- `dart analyze`",
              "- `flutter test`",
              "",
              "PR requirements:",
              "- Title: `chore: biweekly maintenance (" + date + ")`",
              "- Include: dependency summary (majors called out), confirmation `make bump_fix` ran, analyze/test results, and any skipped upgrades + why."
            ].join("\n");

            // Create issue and assign to Copilot, including agent_assignment
            const res = await github.request("POST /repos/{owner}/{repo}/issues", {
              owner,
              repo,
              title,
              body,
              labels: ["maintenance"],
              assignees: ["copilot-swe-agent[bot]"],
              agent_assignment: {
                target_repo: `${owner}/${repo}`,
                base_branch: "main",
                custom_instructions: "",
                custom_agent: "",
                model: ""
              }
            });

            const assignees = (res.data.assignees || []).map(a => a.login);
            core.info(`Created issue #${res.data.number}. Assignees: ${assignees.join(", ")}`);

            if (!assignees.includes("copilot-swe-agent[bot]")) {
              core.setFailed(
                `Issue was created but Copilot was not assigned. Actual assignees: ${assignees.join(", ")}`
              );
            }
